#include "signal.hpp"
#include <cmath>
#include "arm_math.h"
#include "xil_printf.h"

#ifndef M_PI
static constexpr float M_PI = 3.14159265358979323846f;
#endif

signal::signal(Type type, float frequency, float amplitude)
    : type(type), frequency(frequency), amplitude(amplitude)
{
	xil_printf("freq: %i at Ampl: %i\r\n", (int)frequency), (int)(amplitude);
}

void signal::setFrequency(float freq) {
    frequency = freq;
}

void signal::reset() {
    //phase = 0.0f;
}

float signal::nextSample(float globalFrequency, float baseFrequency) {
    float sample = 0.0f;
    //float phaseIncrement = 2.0f * M_PI * frequency / sampleRate;
    float phase = globalFrequency * (frequency / baseFrequency);
    float cyclePhase = std::fmod(phase, 1.0f);

    switch (type) {
        case SINE:
        	sample = std::sin(phase);
            break;
        case SQUARE:
            sample = (cyclePhase < 0.5f) ? 1.0f : -1.0f;
            break;
        case SAW:
            sample = 2.0f * (cyclePhase - 0.5f);
            break;
        case TRIANGLE:
            sample = 1.0f - 4.0f * std::fabs(cyclePhase - 0.5f);
            break;
    }


    return sample * amplitude;
}
