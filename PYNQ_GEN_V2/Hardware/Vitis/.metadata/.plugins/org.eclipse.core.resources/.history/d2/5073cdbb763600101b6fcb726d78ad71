enum EffectType { NONE, ECHO, TREMOLO, DISTORTION, LOWPASS, BITCRUSH, REVERB};
EffectType currentEffect = NONE;


//*********** ECHO effect **************//

#define BUFFER_SIZE 44100

float echo(float sample) {
    static float buffer[BUFFER_SIZE] = {0};
    static int index = 0;

    float delay_ms = 500.0f;
    float gain = 0.4f;
    int sample_rate = 44100;

    int delay_samples = (int)(delay_ms * 0.001f * sample_rate);
    if (delay_samples >= BUFFER_SIZE) delay_samples = BUFFER_SIZE - 1;

    int read_index = (index + BUFFER_SIZE - delay_samples) % BUFFER_SIZE;
    float delayed = buffer[read_index];

    float out = sample + gain * delayed;

    buffer[index] = out;
    index = (index + 1) % BUFFER_SIZE;

    return out;
}

//*********** TREMOLO effect **************//

static float tremoloPhase = 0;
float tremolo(float sample, int sampleRate, float freq = 5.0f)
{
	tremoloPhase += 2.0f * M_PI * freq / sampleRate; // 5Hz
	if (tremoloPhase > 2.0f * M_PI) tremoloPhase -= 2.0f * M_PI;
	float lfo = 0.5f * (1.0f + sinf(tremoloPhase));
	sample *= lfo;
	return sample;
}

//*********** DISTORTION effect **************//

float distortion(float sample, float gain = 2.0f) {
    return tanhf(gain * sample);
}


//*********** LOWPASS effect **************//

float lowpass(float sample, float alpha = 0.1f) {
    static float prev = 0.0f;
    float filtered = alpha * sample + (1.0f - alpha) * prev;
    prev = filtered;
    return filtered;
}


//*********** BITCRUSH effect **************//

float bitcrush(float sample, int bitDepth = 4, int downsampleRate = 4) {
    static int count = 0;
    static float held = 0.0f;

    if (++count >= downsampleRate) {
        count = 0;
        float scale = powf(2, bitDepth - 1);
        held = roundf(sample * scale) / scale;
    }

    return held;
}


//*********** REVERB effect **************//

static float reverbBuffer[44100] = {0}; // 1 sec buffer
static int reverbIndex = 0;

float reverb(float sample) {
    // Tap delays at different offsets
    int tap1 = (reverbIndex + 4370) % 44100;
    int tap2 = (reverbIndex + 12345) % 44100;
    int tap3 = (reverbIndex + 19876) % 44100;

    float reverbSample =
        0.3f * reverbBuffer[tap1] +
        0.2f * reverbBuffer[tap2] +
        0.1f * reverbBuffer[tap3];

    float out = sample + reverbSample;

    // Store new sample with slight damping
    reverbBuffer[reverbIndex] = sample + 0.6f * reverbSample;

    reverbIndex = (reverbIndex + 1) % 44100;
    return out;
}
